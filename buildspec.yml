version: 0.2

env:
    git-credential-helper: yes

phases:
    install:
        runtime-versions:
            nodejs: 16
    build:
        commands:
            - git checkout $(git describe --tags --abbrev=0)
            - npm ci --legacy-peer-deps
            - npm run build:${DEPLOY_STAGE}
    post_build:
        commands:
            - aws s3 sync dist/sotetsu-lab-v3-client s3://${BUCKET_NAME} --delete --cache-control "max-age=2592000"
            - aws s3 cp dist/sotetsu-lab-v3-client/sitemap.xml s3://${BUCKET_NAME}/sitemap.xml --cache-control "max-age=2592000" --content-type "application/xml"
            - aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths '/*'
