<div class="operation-realtime-by-operation-container mat-elevation-z1">
  <table mat-table [dataSource]="dataSource" matSort>
    <ng-container matColumnDef="operationNumber">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>運用</th>
      <td mat-cell *matCellDef="let element">
        <div
          fxLayout="row"
          fxLayoutAlign="center center"
          style="width: 36px; height: 36px; border-radius: 50%; position:relative"
          [ngStyle]="{
            background: colors[element.operationNumber]
          }"
        >
          <span>{{ element.operationNumber }}</span>
          <a
            *ngIf="element.operationNumber"
            style="position: absolute; width: 100%; height: 100%"
            [routerLink]="[
              '/operation/route-diagram',
              {
                id: element.operationId
              }
            ]"
          ></a>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="formationNumber">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>編成</th>
      <td mat-cell *matCellDef="let element">
        <div
          [ngClass]="[
            isIncrementData(element.updateTime) ||
            element.formationNumber === '不明'
              ? 'duplicate'
              : ''
          ]"
        >
          <span>
            {{ element.formationNumber }}
          </span>
          <span *ngIf="isIncrementData(element.updateTime)">?</span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="history">
      <th mat-header-cell *matHeaderCellDef>履歴</th>
      <td mat-cell *matCellDef="let element">
        <button
          mat-icon-button
          (click)="openHistoryDialog(element.operationNumber)"
        >
          <mat-icon>history</mat-icon>
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="currentPoint">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>現在地</th>
      <td mat-cell *matCellDef="let element">
        <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
          <div fxFlex="1 0 32px">
            <a
              fxLayout="column"
              [ngStyle]="{
                color: currentPoints[element.operationNumber]?.tripClassColor
              }"
              [routerLink]="[
                '/timetable/all-line',
                {
                  dia: calender.id,
                  direction:
                    currentPoints[element.operationNumber]?.tripDirection,
                  trip: currentPoints[element.operationNumber]?.tripId
                }
              ]"
            >
              <span>{{
                currentPoints[element.operationNumber]?.tripClass
              }}</span>
              <span>{{
                currentPoints[element.operationNumber]?.tripNumber
              }}</span>
            </a>
          </div>
          <div fxLayout="column" fxFlex="1 0 60px">
            <span>{{
              currentPoints[element.operationNumber]?.startStation
            }}</span>

            <span>{{ currentPoints[element.operationNumber]?.startTime }}</span>
          </div>

          <div fxFlex="auto" fxLayout="row" fxLayoutAlign="start center">
            <mat-icon>arrow_forward</mat-icon>
          </div>

          <div fxLayout="column" fxFlex="1 0 60px">
            <span>{{
              currentPoints[element.operationNumber]?.endStation
            }}</span>
            <span> {{ currentPoints[element.operationNumber]?.endTime }}</span>
          </div>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="sightingTime">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>目撃</th>
      <td mat-cell *matCellDef="let element">
        <span
          [ngClass]="[
            isIncrementData(element.updateTime) ||
            element.formationNumber === '不明'
              ? 'duplicate'
              : ''
          ]"
        >
          <ng-container *ngIf="isIncrementData(element.updateTime)">
            順送り済
          </ng-container>
          <ng-container *ngIf="!isIncrementData(element.updateTime)">
            {{ element.sightingTime | date: 'MM/dd HH:mm' }}
          </ng-container>
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="updateTime">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>更新</th>
      <td mat-cell *matCellDef="let element">
        <span
          [ngClass]="[
            isIncrementData(element.updateTime) ||
            element.formationNumber === '不明'
              ? 'duplicate'
              : ''
          ]"
        >
          {{ element.updateTime | date: 'MM/dd HH:mm' }}
        </span>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
</div>
