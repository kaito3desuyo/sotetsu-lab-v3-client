<table class="tw-h-full tw-w-full tw-border-collapse tw-bg-white">
    <thead>
        <tr
            class="tw-h-16 [&>th+th]:tw-pl-4 [&>th.formationNumber]:tw-w-10 [&>th.operationNumber]:tw-w-9 [&>th:first-child]:tw-pl-6 [&>th:last-child]:tw-pr-6 [&>th]:tw-p-0 [&>th]:tw-text-left [&>th]:tw-text-xs [&>th]:tw-font-normal [&>th]:tw-text-grey-600"
        >
            @for (column of displayedColumns(); track column) {
                <th [class]="[column]">
                    {{ operationRealTimeTableColumnLabel[column] }}
                </th>
            }
        </tr>
    </thead>
    <tbody>
        @for (formation of formations(); track formation.formationId) {
            <tr
                class="tw-h-12 [&>td+td]:tw-pl-4 [&>td.formationNumber]:tw-w-10 [&>td.operationNumber]:tw-w-9 [&>td:first-child]:tw-pl-6 [&>td:last-child]:tw-pr-6 [&>td]:tw-h-full [&>td]:tw-border-0 [&>td]:tw-border-t [&>td]:tw-border-solid [&>td]:tw-border-t-grey-300 [&>td]:tw-p-0 [&>td]:tw-text-sm"
            >
                @for (column of displayedColumns(); track column) {
                    @if (
                        column === operationRealTimeTableColumn.FORMATION_NUMBER
                    ) {
                        <td [class]="[column]">
                            <span>
                                {{ formation.formationNumber }}
                            </span>
                        </td>
                    }

                    @if (
                        column === operationRealTimeTableColumn.OPERATION_NUMBER
                    ) {
                        @let timeCrossSection =
                            queryTimeCrossSectionByFormationNumber(
                                formation.formationNumber
                            )();

                        @let latestSighting = timeCrossSection?.latestSighting;

                        @let expectedSightingOperation =
                            timeCrossSection?.expectedSighting?.operation;

                        @let dayCount =
                            latestSighting?.sightingTime
                                | operationRealTimeDayCount;

                        <td
                            [class]="[column]"
                            class="tw-flex tw-flex-row tw-items-center tw-justify-center"
                        >
                            @if (expectedSightingOperation) {
                                @let operationText =
                                    (expectedSightingOperation.operationNumber ===
                                    '100'
                                        ? '休'
                                        : expectedSightingOperation.operationNumber) +
                                    (dayCount !== 0 ? '?' : '');
                                @let operationTextStyle =
                                    dayCount === 0
                                        ? 'bold'
                                        : dayCount === 1
                                          ? 'underline'
                                          : 'normal';
                                @let operationColor =
                                    expectedSightingOperation.operationNumber
                                        | newOperationNumberColor;
                                @let operationLink =
                                    expectedSightingOperation.operationNumber ===
                                    '100'
                                        ? undefined
                                        : [
                                              '/operation',
                                              'route-diagram',
                                              {
                                                  operation_id:
                                                      expectedSightingOperation.operationId,
                                              },
                                          ];

                                <app-new-operation-number-link
                                    [text]="operationText"
                                    [textStyle]="operationTextStyle"
                                    [bgColor]="operationColor"
                                    [link]="operationLink"
                                ></app-new-operation-number-link>
                            } @else {
                                <span class="tw-text-grey-600"> 不明 </span>
                            }
                        </td>
                    }

                    @if (
                        column ===
                        operationRealTimeTableColumn.SIGHTING_HISTORIES
                    ) {
                        @let timeCrossSection =
                            queryTimeCrossSectionByFormationNumber(
                                formation.formationNumber
                            )();

                        @let latestSighting = timeCrossSection?.latestSighting;

                        @let expectedSightingOperation =
                            timeCrossSection?.expectedSighting?.operation;

                        @let histories =
                            queryHistoriesByFormationNumber(
                                formation.formationNumber
                            )();

                        <td [class]="[column]">
                            <div
                                class="tw-flex tw-h-full tw-w-fit tw-max-w-32 tw-flex-row tw-items-center tw-gap-1 tw-overflow-x-auto"
                            >
                                @for (
                                    history of histories;
                                    track history.operationSightingId
                                ) {
                                    @if (
                                        !expectedSightingOperation ||
                                        latestSighting?.operationSightingId !==
                                            history.operationSightingId
                                    ) {
                                        <mat-icon
                                            class="!tw-h-4 !tw-w-4 tw-min-w-4 tw-text-[16px]"
                                        >
                                            arrow_back
                                        </mat-icon>
                                        <span
                                            class="tw-text-xs"
                                            [matTooltip]="
                                                history.sightingTime
                                                    | dateFns
                                                        : {
                                                              format: '目撃：yyyy/MM/dd HH:mm:ss',
                                                              parseISO: true,
                                                          }
                                            "
                                        >
                                            @let operationNumber =
                                                history.operationId
                                                    | newFindById
                                                        : {
                                                              array: operations(),
                                                              propertyName:
                                                                  'operationId',
                                                              outputPropertyName:
                                                                  'operationNumber',
                                                          };

                                            {{
                                                operationNumber !== '100'
                                                    ? operationNumber
                                                    : '休'
                                            }}
                                        </span>
                                    }
                                }
                            </div>
                        </td>
                    }

                    @if (
                        column === operationRealTimeTableColumn.CURRENT_POSITION
                    ) {
                        @let timeCrossSection =
                            queryTimeCrossSectionByFormationNumber(
                                formation.formationNumber
                            )();

                        @let latestSighting = timeCrossSection?.latestSighting;

                        @let expectedSightingOperation =
                            timeCrossSection?.expectedSighting?.operation;

                        @let currentPosition =
                            queryCurrentPositionByOperationNumber(
                                expectedSightingOperation?.operationNumber
                            )();

                        @let prev = currentPosition?.prev;
                        @let current = currentPosition?.current;
                        @let next = currentPosition?.next;

                        <td [class]="[column]">
                            @if (!!prev || !!current || !!next) {
                                <div
                                    class="tw-flex tw-flex-row tw-items-center tw-gap-4 tw-text-xs tw-leading-4"
                                >
                                    <div class="tw-flex tw-w-14">
                                        @if (!!current) {
                                            <a
                                                [routerLink]="[
                                                    '/timetable',
                                                    'all-line',
                                                    {
                                                        calendar_id:
                                                            calendar()
                                                                ?.calendarId,
                                                        trip_direction:
                                                            current.trip
                                                                .tripDirection,
                                                        trip_block_id:
                                                            current.trip
                                                                .tripBlockId,
                                                    },
                                                ]"
                                                [style.color]="
                                                    current.trip.tripClassId
                                                        | newFindById
                                                            : {
                                                                  array: tripClasses(),
                                                                  propertyName:
                                                                      'tripClassId',
                                                                  outputPropertyName:
                                                                      'tripClassColor',
                                                              }
                                                "
                                            >
                                                {{
                                                    current.trip.tripClassId
                                                        | newFindById
                                                            : {
                                                                  array: tripClasses(),
                                                                  propertyName:
                                                                      'tripClassId',
                                                                  outputPropertyName:
                                                                      'tripClassName',
                                                              }
                                                        | newAntiBrackets
                                                }}
                                                <br />
                                                {{ current.trip.tripNumber }}
                                            </a>
                                        }
                                    </div>
                                    <div class="tw-flex tw-w-20">
                                        @if (!prev && !current && !!next) {
                                            <span>
                                                @if (!!next.trip.depotOut) {
                                                    出庫前<br />〇
                                                } @else {
                                                    不明<br />？
                                                }
                                            </span>
                                        }

                                        @if (!prev && !!current && !next) {
                                            <span>
                                                {{
                                                    current.startTime.stationId
                                                        | newFindById
                                                            : {
                                                                  array: stations(),
                                                                  propertyName:
                                                                      'stationId',
                                                                  outputPropertyName:
                                                                      'stationName',
                                                              }
                                                }}
                                                <br />
                                                {{
                                                    current.startTime
                                                        .departureTime
                                                }}
                                            </span>
                                        }

                                        @if (!!prev && !current && !!next) {
                                            <span>
                                                {{
                                                    prev.endTime.stationId
                                                        | newFindById
                                                            : {
                                                                  array: stations(),
                                                                  propertyName:
                                                                      'stationId',
                                                                  outputPropertyName:
                                                                      'stationName',
                                                              }
                                                }}
                                                <br />
                                                {{ prev.endTime.arrivalTime }}
                                            </span>
                                        }

                                        @if (!!prev && !current && !next) {
                                            <span>
                                                {{
                                                    prev.endTime.stationId
                                                        | newFindById
                                                            : {
                                                                  array: stations(),
                                                                  propertyName:
                                                                      'stationId',
                                                                  outputPropertyName:
                                                                      'stationName',
                                                              }
                                                }}
                                                <br />
                                                {{ prev.endTime.arrivalTime }}
                                            </span>
                                        }
                                    </div>
                                    <div
                                        class="tw-flex tw-flex-row tw-items-center"
                                    >
                                        <mat-icon class="tw-leading-[normal]">
                                            arrow_forward
                                        </mat-icon>
                                    </div>
                                    <div class="tw-flex tw-w-20">
                                        @if (!prev && !current && !!next) {
                                            <span>
                                                {{
                                                    next.startTime.stationId
                                                        | newFindById
                                                            : {
                                                                  array: stations(),
                                                                  propertyName:
                                                                      'stationId',
                                                                  outputPropertyName:
                                                                      'stationName',
                                                              }
                                                }}
                                                <br />
                                                {{
                                                    next.startTime.departureTime
                                                }}
                                            </span>
                                        }

                                        @if (!prev && !!current && !next) {
                                            <span>
                                                {{
                                                    current.endTime.stationId
                                                        | newFindById
                                                            : {
                                                                  array: stations(),
                                                                  propertyName:
                                                                      'stationId',
                                                                  outputPropertyName:
                                                                      'stationName',
                                                              }
                                                }}
                                                <br />
                                                {{
                                                    current.endTime.arrivalTime
                                                }}
                                            </span>
                                        }

                                        @if (!!prev && !current && !!next) {
                                            <span>
                                                @if (
                                                    prev.endTime.stationId ===
                                                    next.startTime.stationId
                                                ) {
                                                    @if (prev.trip.depotIn) {
                                                        一時入庫
                                                    } @else {
                                                        停車中
                                                    }
                                                } @else {
                                                    {{
                                                        next.startTime.stationId
                                                            | newFindById
                                                                : {
                                                                      array: stations(),
                                                                      propertyName:
                                                                          'stationId',
                                                                      outputPropertyName:
                                                                          'stationName',
                                                                  }
                                                    }}
                                                }
                                                <br />
                                                {{
                                                    next.startTime.departureTime
                                                }}
                                            </span>
                                        }

                                        @if (!!prev && !current && !next) {
                                            <span>
                                                @if (prev.trip.depotIn) {
                                                    入庫済<br />△
                                                } @else {
                                                    不明<br />？
                                                }
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </td>
                    }

                    @if (
                        column === operationRealTimeTableColumn.SIGHTING_TIME
                    ) {
                        @let timeCrossSection =
                            queryTimeCrossSectionByFormationNumber(
                                formation.formationNumber
                            )();

                        @let latestSighting = timeCrossSection?.latestSighting;

                        @let sightingTime = latestSighting?.sightingTime;

                        <td [class]="[column]">
                            @if (sightingTime) {
                                <span
                                    class="tw-text-sm tw-leading-none"
                                    [style.color]="
                                        (sightingTime
                                            | operationRealTimeDayCount) === 0
                                            ? '#f44336'
                                            : (sightingTime
                                                    | operationRealTimeDayCount) ===
                                                1
                                              ? '#4caf50'
                                              : 'initial'
                                    "
                                >
                                    {{
                                        sightingTime
                                            | dateFns
                                                : {
                                                      format: 'yyyy/MM/dd HH:mm:ss',
                                                      parseISO: true,
                                                  }
                                    }}
                                </span>
                            } @else {
                                <span class="tw-text-grey-600">不明</span>
                            }
                        </td>
                    }

                    @if (column === operationRealTimeTableColumn.UPDATED_AT) {
                        @let timeCrossSection =
                            queryTimeCrossSectionByFormationNumber(
                                formation.formationNumber
                            )();

                        @let latestSighting = timeCrossSection?.latestSighting;

                        @let updatedAt = latestSighting?.updatedAt;

                        <td>
                            @if (updatedAt) {
                                <span
                                    class="tw-text-sm tw-leading-none"
                                    [style.color]="
                                        (updatedAt
                                            | operationRealTimeDayCount) === 0
                                            ? '#f44336'
                                            : (updatedAt
                                                    | operationRealTimeDayCount) ===
                                                1
                                              ? '#4caf50'
                                              : 'initial'
                                    "
                                >
                                    {{
                                        updatedAt
                                            | dateFns
                                                : {
                                                      format: 'yyyy/MM/dd HH:mm:ss',
                                                      parseISO: true,
                                                  }
                                    }}
                                </span>
                            } @else {
                                <span class="tw-text-grey-600">不明</span>
                            }
                        </td>
                    }
                }
            </tr>
        }
    </tbody>
</table>
